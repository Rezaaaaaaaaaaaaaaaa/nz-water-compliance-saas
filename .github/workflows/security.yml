name: Security Audit

on:
  schedule:
    # Run every Monday at 8 AM UTC
    - cron: '0 8 * * 1'
  push:
    branches: [main]
    paths:
      - 'package*.json'
      - 'backend/package*.json'
      - 'frontend/package*.json'

env:
  NODE_VERSION: '20'

jobs:
  npm-audit:
    name: npm Audit
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Install backend dependencies
        run: cd backend && npm ci

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Run npm audit on root
        run: npm audit --production
        continue-on-error: true

      - name: Run npm audit on backend
        run: cd backend && npm audit --production
        continue-on-error: true

      - name: Run npm audit on frontend
        run: cd frontend && npm audit --production
        continue-on-error: true

      - name: Check for high severity vulnerabilities
        run: |
          echo "Checking for HIGH severity vulnerabilities..."

          # Run audit and capture JSON
          cd backend && npm audit --json > audit.json || true

          # Check if there are high severity issues
          HIGH_COUNT=$(jq '.metadata.vulnerabilities.high // 0' audit.json)
          CRITICAL_COUNT=$(jq '.metadata.vulnerabilities.critical // 0' audit.json)

          echo "Backend - Critical: $CRITICAL_COUNT, High: $HIGH_COUNT"

          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "❌ Found CRITICAL vulnerabilities in backend"
            exit 1
          fi

          if [ "$HIGH_COUNT" -gt 0 ]; then
            echo "⚠️  Found HIGH severity vulnerabilities in backend"
          fi

  dependency-check:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci
          cd ../frontend && npm ci

      - name: Check for outdated packages
        run: |
          echo "=== Checking for outdated packages ==="
          npm outdated || true

          echo ""
          echo "=== Backend ==="
          cd backend && npm outdated || true

          echo ""
          echo "=== Frontend ==="
          cd ../frontend && npm outdated || true

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci
          cd ../frontend && npm ci

      - name: Check licenses
        run: |
          # Install license checker
          npm install -g license-checker

          echo "=== Backend Licenses ==="
          cd backend && license-checker --json > licenses.json || true

          # Check for problematic licenses
          PROBLEMATIC=$(jq 'to_entries[] | select(.value.licenses | contains("GPL") or contains("AGPL") or contains("SSPL")) | .key' licenses.json | wc -l)

          if [ "$PROBLEMATIC" -gt 0 ]; then
            echo "⚠️  Found potentially problematic licenses (GPL/AGPL/SSPL)"
          fi

  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript']
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        continue-on-error: true

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

  results:
    name: Security Check Results
    runs-on: ubuntu-latest
    needs: [npm-audit, dependency-check]
    if: always()
    steps:
      - name: Check audit results
        if: needs.npm-audit.result != 'success'
        run: |
          echo "⚠️  npm audit found vulnerabilities"
          echo "Review the audit results and update dependencies"

      - name: Generate summary
        run: |
          echo "## Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- npm Audit: ${{ needs.npm-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Check: ${{ needs.dependency-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Recommendations:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review npm audit results: \`npm audit\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Update dependencies: \`npm update\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Check for breaking changes before updating" >> $GITHUB_STEP_SUMMARY
