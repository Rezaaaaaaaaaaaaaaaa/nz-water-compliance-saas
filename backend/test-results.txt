
> compliance-saas-backend@1.0.0 test
> jest

FAIL src/__tests__/setup.ts
  ‚óè Test suite failed to run

    Your test suite must contain at least one test.

      at onResult (node_modules/@jest/core/build/TestScheduler.js:133:18)
      at node_modules/@jest/core/build/TestScheduler.js:254:19
      at node_modules/emittery/index.js:363:13
          at Array.map (<anonymous>)
      at Emittery.emit (node_modules/emittery/index.js:361:23)

PASS src/__tests__/services/asset.service.test.ts (34.09 s)
FAIL src/__tests__/services/dwsp.service.test.ts (34.686 s)
  ‚óè DWSP Service ‚Ä∫ validateDWSP ‚Ä∫ should validate a complete DWSP with all 12 elements

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 64 |[39m       [36mconst[39m validation [33m=[39m dwspService[33m.[39mvalidateDWSP(completeDWSP)[33m;[39m
     [90m 65 |[39m
    [31m[1m>[22m[39m[90m 66 |[39m       expect(validation[33m.[39misValid)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m    |[39m                                  [31m[1m^[22m[39m
     [90m 67 |[39m       expect(validation[33m.[39mmissingElements)[33m.[39mtoHaveLength([35m0[39m)[33m;[39m
     [90m 68 |[39m       expect(validation[33m.[39merrors)[33m.[39mtoHaveLength([35m0[39m)[33m;[39m
     [90m 69 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/dwsp.service.test.ts:66:34)

  ‚óè DWSP Service ‚Ä∫ validateDWSP ‚Ä∫ should identify missing water supply description

    expect(received).toContain(expected) // indexOf

    Expected value: "1. Water Supply Description"
    Received array: ["1. Hazard Identification", "2. Risk Assessment", "3. Preventive Measures / Control Measures", "4. Operational Monitoring", "5. Verification Monitoring", "6. Corrective Actions", "8. Emergency Response Procedures", "9. Residual Disinfection (or exemption)", "10. Water Quantity Planning", "12. Review and Amendment Procedures"]

    [0m [90m 78 |[39m
     [90m 79 |[39m       expect(validation[33m.[39misValid)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 80 |[39m       expect(validation[33m.[39mmissingElements)[33m.[39mtoContain(
     [90m    |[39m                                          [31m[1m^[22m[39m
     [90m 81 |[39m         [32m'1. Water Supply Description'[39m
     [90m 82 |[39m       )[33m;[39m
     [90m 83 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/dwsp.service.test.ts:80:42)

  ‚óè DWSP Service ‚Ä∫ validateDWSP ‚Ä∫ should identify missing hazard identification

    expect(received).toContain(expected) // indexOf

    Expected value: "2. Hazard Identification"
    Received array: ["1. Hazard Identification", "2. Risk Assessment", "3. Preventive Measures / Control Measures", "4. Operational Monitoring", "5. Verification Monitoring", "6. Corrective Actions", "8. Emergency Response Procedures", "9. Residual Disinfection (or exemption)", "10. Water Quantity Planning", "12. Review and Amendment Procedures"]

    [0m [90m 94 |[39m
     [90m 95 |[39m       expect(validation[33m.[39misValid)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 96 |[39m       expect(validation[33m.[39mmissingElements)[33m.[39mtoContain([32m'2. Hazard Identification'[39m)[33m;[39m
     [90m    |[39m                                          [31m[1m^[22m[39m
     [90m 97 |[39m     })[33m;[39m
     [90m 98 |[39m
     [90m 99 |[39m     it([32m'should identify missing risk assessment'[39m[33m,[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/__tests__/services/dwsp.service.test.ts:96:42)

  ‚óè DWSP Service ‚Ä∫ validateDWSP ‚Ä∫ should identify missing risk assessment

    expect(received).toContain(expected) // indexOf

    Expected value: "3. Risk Assessment"
    Received array: ["2. Risk Assessment", "3. Preventive Measures / Control Measures", "4. Operational Monitoring", "5. Verification Monitoring", "6. Corrective Actions", "8. Emergency Response Procedures", "9. Residual Disinfection (or exemption)", "10. Water Quantity Planning", "12. Review and Amendment Procedures"]

    [0m [90m 107 |[39m
     [90m 108 |[39m       expect(validation[33m.[39misValid)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 109 |[39m       expect(validation[33m.[39mmissingElements)[33m.[39mtoContain([32m'3. Risk Assessment'[39m)[33m;[39m
     [90m     |[39m                                          [31m[1m^[22m[39m
     [90m 110 |[39m     })[33m;[39m
     [90m 111 |[39m
     [90m 112 |[39m     it([32m'should identify all missing elements in empty DWSP'[39m[33m,[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/__tests__/services/dwsp.service.test.ts:109:42)

  ‚óè DWSP Service ‚Ä∫ validateDWSP ‚Ä∫ should identify all missing elements in empty DWSP

    expect(received).toContain(expected) // indexOf

    Expected value: "1. Water Supply Description"
    Received array: ["1. Hazard Identification", "2. Risk Assessment", "3. Preventive Measures / Control Measures", "4. Operational Monitoring", "5. Verification Monitoring", "6. Corrective Actions", "8. Emergency Response Procedures", "9. Residual Disinfection (or exemption)", "10. Water Quantity Planning", "12. Review and Amendment Procedures"]

    [0m [90m 117 |[39m       expect(validation[33m.[39misValid)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
     [90m 118 |[39m       expect(validation[33m.[39mmissingElements[33m.[39mlength)[33m.[39mtoBeGreaterThan([35m0[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 119 |[39m       expect(validation[33m.[39mmissingElements)[33m.[39mtoContain(
     [90m     |[39m                                          [31m[1m^[22m[39m
     [90m 120 |[39m         [32m'1. Water Supply Description'[39m
     [90m 121 |[39m       )[33m;[39m
     [90m 122 |[39m       expect(validation[33m.[39mmissingElements)[33m.[39mtoContain([32m'2. Hazard Identification'[39m)[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/dwsp.service.test.ts:119:42)

  ‚óè DWSP Service ‚Ä∫ validateDWSP ‚Ä∫ should validate all 12 mandatory elements are checked

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

    [0m [90m 171 |[39m           missing[33m.[39mincludes(element)
     [90m 172 |[39m         )[33m;[39m
    [31m[1m>[22m[39m[90m 173 |[39m         expect(found)[33m.[39mtoBe([36mtrue[39m)[33m;[39m
     [90m     |[39m                       [31m[1m^[22m[39m
     [90m 174 |[39m       })[33m;[39m
     [90m 175 |[39m     })[33m;[39m
     [90m 176 |[39m   })[33m;[39m[0m

      at src/__tests__/services/dwsp.service.test.ts:173:23
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/__tests__/services/dwsp.service.test.ts:169:24)

  ‚óè DWSP Service ‚Ä∫ DWSP Compliance Requirements ‚Ä∫ should enforce minimum hazard count

    expect(received).toContain(expected) // indexOf

    Expected value: "2. Hazard Identification"
    Received array: ["1. Hazard Identification", "2. Risk Assessment", "8. Emergency Response Procedures"]

    [0m [90m 196 |[39m
     [90m 197 |[39m       expect(validation[33m.[39misValid)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 198 |[39m       expect(validation[33m.[39mmissingElements)[33m.[39mtoContain([32m'2. Hazard Identification'[39m)[33m;[39m
     [90m     |[39m                                          [31m[1m^[22m[39m
     [90m 199 |[39m     })[33m;[39m
     [90m 200 |[39m
     [90m 201 |[39m     it([32m'should require at least one preventive measure'[39m[33m,[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/__tests__/services/dwsp.service.test.ts:198:42)

  ‚óè DWSP Service ‚Ä∫ DWSP Compliance Requirements ‚Ä∫ should require at least one preventive measure

    expect(received).toContain(expected) // indexOf

    Expected value: "4. Preventive Measures"
    Received array: ["2. Risk Assessment", "3. Preventive Measures / Control Measures", "8. Emergency Response Procedures"]

    [0m [90m 218 |[39m
     [90m 219 |[39m       expect(validation[33m.[39misValid)[33m.[39mtoBe([36mfalse[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 220 |[39m       expect(validation[33m.[39mmissingElements)[33m.[39mtoContain([32m'4. Preventive Measures'[39m)[33m;[39m
     [90m     |[39m                                          [31m[1m^[22m[39m
     [90m 221 |[39m     })[33m;[39m
     [90m 222 |[39m   })[33m;[39m
     [90m 223 |[39m })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/dwsp.service.test.ts:220:42)

PASS src/__tests__/services/analytics.service.test.ts (35.039 s)
FAIL src/__tests__/services/export.service.test.ts (35.138 s)
  ‚óè Export Service ‚Ä∫ exportAssetsToCSV ‚Ä∫ should export assets to CSV format with headers

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 4

    [0m [90m 102 |[39m       [90m// Check null handling[39m
     [90m 103 |[39m       [36mconst[39m lines [33m=[39m csv[33m.[39msplit([32m'\n'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 104 |[39m       expect(lines[33m.[39mlength)[33m.[39mtoBe([35m3[39m)[33m;[39m [90m// Header + 2 data rows + empty line[39m
     [90m     |[39m                            [31m[1m^[22m[39m
     [90m 105 |[39m     })[33m;[39m
     [90m 106 |[39m
     [90m 107 |[39m     it([32m'should escape CSV special characters'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/__tests__/services/export.service.test.ts:104:28)

  ‚óè Export Service ‚Ä∫ exportDocumentsToCSV ‚Ä∫ should export documents with uploader information

    expect(received).toContain(expected) // indexOf

    Expected substring: "doc-1,DWSP 2024,DWSP"
    Received string:    "ID,Title,Type,Description,File Name,File Size (MB),MIME Type,Version,Tags,Uploaded By,Uploaded At,Retention Until
    doc-1,DWSP 2024,,Annual safety plan,dwsp_2024.pdf,1.00,,1,safety; annual,John Doe,2024-01-15,2031-01-15
    "

    [0m [90m 181 |[39m
     [90m 182 |[39m       expect(csv)[33m.[39mtoContain([32m'ID,Title,Type,Description'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 183 |[39m       expect(csv)[33m.[39mtoContain([32m'doc-1,DWSP 2024,DWSP'[39m)[33m;[39m
     [90m     |[39m                   [31m[1m^[22m[39m
     [90m 184 |[39m       expect(csv)[33m.[39mtoContain([32m'John Doe'[39m)[33m;[39m
     [90m 185 |[39m       expect(csv)[33m.[39mtoContain([32m'1.00'[39m)[33m;[39m [90m// File size in MB[39m
     [90m 186 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/export.service.test.ts:183:19)

  ‚óè Export Service ‚Ä∫ exportComplianceOverviewReport ‚Ä∫ should generate formatted text report

    expect(received).toContain(expected) // indexOf

    Expected substring: "Wellington DWSP 2024"
    Received string:    "===============================================================================
                        COMPLIANCE OVERVIEW REPORT
                        Taumata Arowai Requirements
    ===============================================================================¬∑
    Organization: Wellington Water Ltd
    Report Date:  2025-10-05
    Generated:    2025-10-05 19:45:54¬∑
    ===============================================================================
                            EXECUTIVE SUMMARY
    ===============================================================================¬∑
    Total Assets:             2
    Critical Assets:          1 (50.0%)
    Total Documents:          50
    Active DWSPs:             0
    Total Compliance Plans:   2
    Reports Submitted:        0¬∑
    ===============================================================================
                          DWSP (DRINKING WATER SAFETY PLAN)
    ===============================================================================¬∑
    Total DWSPs:              0
    Approved:                 0
    In Review:                0
    Draft:                    0
    Rejected:                 0¬∑
    No approved DWSPs found¬∑¬∑
    ===============================================================================
                            ASSET MANAGEMENT
    ===============================================================================¬∑
    Asset Breakdown by Risk Level:
      LOW: 1 (50.0%)
      CRITICAL: 1 (50.0%)¬∑
    Asset Breakdown by Condition:
      GOOD: 1 (50.0%)
      FAIR: 1 (50.0%)¬∑
    Critical Assets Requiring Attention:
      - Critical Tank (TANK) - FAIR condition, CRITICAL risk¬∑
    ===============================================================================
                            RECENT ACTIVITY (Last 30 Days)
    ===============================================================================¬∑
    Total Actions:            2¬∑
    Activity Breakdown:
      ASSET_CREATED: 1
      DOCUMENT_UPLOADED: 1¬∑
    ===============================================================================
                            COMPLIANCE STATUS
    ===============================================================================¬∑
    ‚úì Organization registered with system
    ‚úó Approved DWSP on file
    ‚úì Assets registered and tracked
    ‚úì Documentation uploaded
    ‚úó Compliance reports submitted¬∑
    ===============================================================================
                            RECOMMENDATIONS
    ===============================================================================¬∑
    1. ! CRITICAL: Create and submit a Drinking Water Safety Plan (DWSP) immediately
    2. ! MEDIUM: High percentage of critical risk assets - prioritize maintenance
    3. ! MEDIUM: Begin regular compliance reporting¬∑
    ===============================================================================
                                  END OF REPORT
    ===============================================================================¬∑
    This report was generated automatically by the NZ Water Compliance SaaS
    system to assist with Taumata Arowai regulatory compliance requirements.¬∑
    For questions or support, contact your system administrator."

    [0m [90m 348 |[39m       expect(report)[33m.[39mtoContain([32m'Critical Assets:          1'[39m)[33m;[39m
     [90m 349 |[39m       expect(report)[33m.[39mtoContain([32m'Total Documents:          50'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 350 |[39m       expect(report)[33m.[39mtoContain([32m'Wellington DWSP 2024'[39m)[33m;[39m
     [90m     |[39m                      [31m[1m^[22m[39m
     [90m 351 |[39m     })[33m;[39m
     [90m 352 |[39m
     [90m 353 |[39m     it([32m'should provide recommendations for missing DWSP'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/__tests__/services/export.service.test.ts:350:22)

FAIL src/__tests__/services/compliance-scoring.service.test.ts (35.162 s)
  ‚óè Compliance Scoring Service ‚Ä∫ calculateComplianceScore ‚Ä∫ should calculate perfect score (100) for ideal compliance

    expect(received).toBeGreaterThanOrEqual(expected)

    Expected: >= 95
    Received:    78

    [0m [90m 113 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m calculateComplianceScore(organizationId)[33m;[39m
     [90m 114 |[39m
    [31m[1m>[22m[39m[90m 115 |[39m       expect(result[33m.[39moverall)[33m.[39mtoBeGreaterThanOrEqual([35m95[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 116 |[39m       expect(result[33m.[39moverall)[33m.[39mtoBeLessThanOrEqual([35m100[39m)[33m;[39m
     [90m 117 |[39m       expect(result[33m.[39mtrend)[33m.[39mtoBe([32m'unknown'[39m)[33m;[39m [90m// No historical data[39m
     [90m 118 |[39m     })[33m;[39m[0m

      at Object.<anonymous> (src/__tests__/services/compliance-scoring.service.test.ts:115:30)

  ‚óè Compliance Scoring Service ‚Ä∫ calculateComplianceScore ‚Ä∫ should penalize for overdue items

    expect(received).toBeLessThan(expected)

    Expected: < 100
    Received:   100

    [0m [90m 176 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m calculateComplianceScore(organizationId)[33m;[39m
     [90m 177 |[39m
    [31m[1m>[22m[39m[90m 178 |[39m       expect(result[33m.[39mbreakdown[33m.[39mtimeliness[33m.[39mscore)[33m.[39mtoBeLessThan([35m100[39m)[33m;[39m
     [90m     |[39m                                                 [31m[1m^[22m[39m
     [90m 179 |[39m     })[33m;[39m
     [90m 180 |[39m
     [90m 181 |[39m     it([32m'should generate critical recommendations for missing DWSP'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at Object.<anonymous> (src/__tests__/services/compliance-scoring.service.test.ts:178:49)

{"level":30,"timestamp":"2025-10-05T19:45:54.271Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","count":2,"msg":"Assets exported to CSV"}
{"level":30,"timestamp":"2025-10-05T19:45:54.315Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","overallScore":78,"msg":"Compliance score calculated and saved"}
{"level":30,"timestamp":"2025-10-05T19:45:54.291Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","count":1,"msg":"Assets exported to CSV"}
{"level":30,"timestamp":"2025-10-05T19:45:54.293Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","count":0,"msg":"Assets exported to CSV"}
{"level":30,"timestamp":"2025-10-05T19:45:54.295Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","count":1,"msg":"Documents exported to CSV"}
{"level":30,"timestamp":"2025-10-05T19:45:54.297Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","count":1,"msg":"Documents exported to CSV"}
{"level":30,"timestamp":"2025-10-05T19:45:54.298Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","count":2,"msg":"Audit logs exported to CSV"}
{"level":30,"timestamp":"2025-10-05T19:45:54.299Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","count":0,"msg":"Audit logs exported to CSV"}
{"level":30,"timestamp":"2025-10-05T19:45:54.301Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","msg":"Compliance overview report generated"}
{"level":30,"timestamp":"2025-10-05T19:45:54.303Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","msg":"Compliance overview report generated"}
{"level":30,"timestamp":"2025-10-05T19:45:54.328Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","overallScore":11,"msg":"Compliance score calculated and saved"}
{"level":30,"timestamp":"2025-10-05T19:45:54.330Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","overallScore":81,"msg":"Compliance score calculated and saved"}
{"level":30,"timestamp":"2025-10-05T19:45:54.332Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","overallScore":11,"msg":"Compliance score calculated and saved"}
{"level":30,"timestamp":"2025-10-05T19:45:54.333Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","overallScore":79,"msg":"Compliance score calculated and saved"}
{"level":30,"timestamp":"2025-10-05T19:45:54.334Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","overallScore":79,"msg":"Compliance score calculated and saved"}
{"level":30,"timestamp":"2025-10-05T19:45:54.335Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","overallScore":79,"msg":"Compliance score calculated and saved"}
{"level":30,"timestamp":"2025-10-05T19:45:54.337Z","env":"test","app":"compliance-saas-backend","organizationId":"test-org-123","overallScore":73,"msg":"Compliance score calculated and saved"}
FAIL src/__tests__/integration/api.test.ts
  ‚óè Test suite failed to run

    [96msrc/server.ts[0m:[93m305[0m:[93m5[0m - [91merror[0m[90m TS1343: [0mThe 'import.meta' meta-property is only allowed when the '--module' option is 'es2020', 'es2022', 'esnext', 'system', 'node16', 'node18', 'node20', or 'nodenext'.

    [7m305[0m if (import.meta.url === `file://${process.argv[1]}`) {
    [7m   [0m [91m    ~~~~~~~~~~~[0m

{"level":30,"timestamp":"2025-10-05T19:45:56.630Z","env":"test","app":"compliance-saas-backend","provider":"console","to":"recipient@example.com","from":"FlowComply <test@example.com>","subject":"Test Email","bodyPreview":"Test content","msg":"üìß Email would be sent (console mode)"}
{"level":30,"timestamp":"2025-10-05T19:45:56.680Z","env":"test","app":"compliance-saas-backend","provider":"console","to":"user@test.com","from":"Test System <noreply@test.com>","subject":"üîî Upcoming Deadline: Q4 2024 DWSP Review (7 days)","bodyPreview":"Hello John Doe,\n\nThis is a reminder notification about a compliance deadline.\n\nQ4 2024 DWSP Review\nT","msg":"üìß Email would be sent (console mode)"}
{"level":30,"timestamp":"2025-10-05T19:45:56.713Z","env":"test","app":"compliance-saas-backend","provider":"console","to":"user@test.com","from":"Test System <noreply@test.com>","subject":"‚ö†Ô∏è OVERDUE: Overdue DWSP","bodyPreview":"Hello Jane Smith,\n\nThis is a OVERDUE notification about a compliance deadline.\n\nOverdue DWSP\nType: C","msg":"üìß Email would be sent (console mode)"}
PASS src/__tests__/services/s3.service.test.ts (37.646 s)
{"level":30,"timestamp":"2025-10-05T19:45:56.744Z","env":"test","app":"compliance-saas-backend","provider":"console","to":"user@test.com","from":"Test System <noreply@test.com>","subject":"üìã Quarterly Regulation Review Required - Q4 2024","bodyPreview":"Quarterly Regulation Review - Q4 2024\n\nHello John Doe,\n\nIt's time for the quarterly review of Taumat","msg":"üìß Email would be sent (console mode)"}
{"level":30,"timestamp":"2025-10-05T19:45:56.776Z","env":"test","app":"compliance-saas-backend","provider":"console","to":"user@test.com","from":"Test System <noreply@test.com>","subject":"‚úÖ DWSP Submitted Successfully - Wellington DWSP 2024","bodyPreview":"\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <style>\n        body { font-family: Arial, sans-ser","msg":"üìß Email would be sent (console mode)"}
{"level":40,"timestamp":"2025-10-05T19:45:57.226Z","env":"test","app":"compliance-saas-backend","attempt":1,"maxAttempts":3,"delay":1000,"err":{"$fault":"client","$metadata":{"attempts":1,"httpStatusCode":403,"requestId":"984b4deb-2ade-4fa5-b4df-c30e2e2d2e89","totalRetryDelay":0},"$response":{"body":{"_consuming":false,"_dumped":false,"_events":{},"_eventsCount":2,"_readableState":{"awaitDrainWriters":null,"buffer":[],"bufferIndex":0,"highWaterMark":16384,"length":0,"pipes":[]},"aborted":false,"client":{"_SNICallback":null,"_closeAfterHandlingError":false,"_controlReleased":true,"_events":{"close":"[Array]"},"_eventsCount":9,"_hadError":false,"_host":"email.ap-southeast-2.amazonaws.com","_httpMessage":null,"_newSessionPending":false,"_parent":null,"_pendingData":null,"_pendingEncoding":"","_readableState":{"awaitDrainWriters":null,"buffer":[],"bufferIndex":0,"highWaterMark":16384,"length":0,"pipes":[]},"_rejectUnauthorized":true,"_requestCert":true,"_secureEstablished":true,"_securePending":false,"_server":null,"_sockname":null,"_tlsOptions":{"isServer":false,"pipe":false,"rejectUnauthorized":true,"requestCert":true,"secureContext":"[Object]"},"_writableState":{"bufferedIndex":0,"corked":0,"highWaterMark":16384,"length":0,"pendingcb":0,"writelen":0},"allowHalfOpen":false,"alpnProtocol":false,"authorizationError":null,"authorized":true,"autoSelectFamilyAttemptedAddresses":["16.176.84.178:443"],"connecting":false,"encrypted":true,"parser":null,"secureConnecting":false,"servername":"email.ap-southeast-2.amazonaws.com","ssl":{"_parent":"[Object]","_parentWrap":null,"_secureContext":"[Object]","reading":true},"timeout":0},"complete":true,"httpVersion":"1.1","httpVersionMajor":1,"httpVersionMinor":1,"method":null,"rawHeaders":["Date","Sun, 05 Oct 2025 19:45:57 GMT","Content-Type","text/xml","Content-Length","305","Connection","keep-alive","x-amzn-RequestId","984b4deb-2ade-4fa5-b4df-c30e2e2d2e89"],"rawTrailers":[],"req":{"_closed":true,"_contentLength":"270","_defaultKeepAlive":true,"_ended":true,"_events":{},"_eventsCount":2,"_hasBody":true,"_header":"POST / HTTP/1.1\r\ncontent-type: application/x-www-form-urlencoded\r\ncontent-length: 270\r\nx-amz-user-agent: aws-sdk-js/3.901.0\r\nuser-agent: aws-sdk-js/3.901.0 ua/2.1 os/win32#10.0.26100 lang/js md/nodejs#23.10.0 api/ses#3.901.0 m/E,e\r\nhost: email.ap-southeast-2.amazonaws.com\r\namz-sdk-invocation-id: 59346735-8ffd-48b2-b6d4-681305a89b1a\r\namz-sdk-request: attempt=1; max=3\r\nx-amz-date: 20251005T194556Z\r\nx-amz-content-sha256: 58d16f9d1f363dafae1f6bbdefe9fc719126e1048cc5178c46fa68e14159cb83\r\nauthorization: AWS4-HMAC-SHA256 Credential=test-key/20251005/ap-southeast-2/ses/aws4_request, SignedHeaders=amz-sdk-invocation-id;amz-sdk-request;content-length;content-type;host;x-amz-content-sha256;x-amz-date;x-amz-user-agent, Signature=5b8976df50f4c28995030619519a552dfaa586c49e7cfbb31c9962e5ded36848\r\nConnection: keep-alive\r\n\r\n","_headerSent":true,"_keepAliveTimeout":0,"_last":false,"_removedConnection":false,"_removedContLen":false,"_removedTE":false,"_trailer":"","aborted":false,"agent":{"_events":"[Object]","_eventsCount":2,"_sessionCache":"[Object]","defaultPort":443,"freeSockets":"[Object]","keepAlive":true,"keepAliveMsecs":1000,"maxCachedSessions":100,"maxFreeSockets":256,"maxSockets":50,"maxTotalSockets":null,"options":"[Object]","protocol":"https:","requests":{},"scheduling":"lifo","sockets":{},"totalSocketCount":1},"chunkedEncoding":false,"destroyed":true,"finished":true,"host":"email.ap-southeast-2.amazonaws.com","maxHeadersCount":null,"maxRequestsOnConnectionReached":false,"method":"POST","outputData":[],"outputSize":0,"parser":null,"path":"/","protocol":"https:","res":"[Circular]","reusedSocket":false,"sendDate":false,"shouldKeepAlive":true,"strictContentLength":false,"timeoutCb":null,"upgradeOrConnect":false,"useChunkedEncodingByDefault":true,"writable":true},"socket":null,"statusCode":403,"statusMessage":"Forbidden","upgrade":false,"url":""},"headers":{"connection":"keep-alive","content-length":"305","content-type":"text/xml","date":"Sun, 05 Oct 2025 19:45:57 GMT","x-amzn-requestid":"984b4deb-2ade-4fa5-b4df-c30e2e2d2e89"},"reason":"Forbidden","statusCode":403},"Code":"InvalidClientTokenId","Type":"Sender","message":"The security token included in the request is invalid.","name":"InvalidClientTokenId","stack":"InvalidClientTokenId: The security token included in the request is invalid.\n    at throwDefaultError (C:\\compliance-saas\\backend\\node_modules\\@smithy\\smithy-client\\dist-cjs\\index.js:287:22)\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\smithy-client\\dist-cjs\\index.js:296:9\n    at de_CommandError (C:\\compliance-saas\\backend\\node_modules\\@aws-sdk\\client-ses\\dist-cjs\\index.js:2934:14)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\middleware-serde\\dist-cjs\\index.js:8:24\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\core\\dist-cjs\\index.js:121:20\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\middleware-retry\\dist-cjs\\index.js:254:46\n    at C:\\compliance-saas\\backend\\node_modules\\@aws-sdk\\middleware-logger\\dist-cjs\\index.js:33:22\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:73:7)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSES (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:46:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:179:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:132:9)","type":"SESServiceException"},"msg":"Operation failed, retrying..."}
{"level":40,"timestamp":"2025-10-05T19:45:57.239Z","env":"test","app":"compliance-saas-backend","attempt":1,"to":"recipient@example.com","err":{"$fault":"client","$metadata":{"attempts":1,"httpStatusCode":403,"requestId":"984b4deb-2ade-4fa5-b4df-c30e2e2d2e89","totalRetryDelay":0},"$response":{"body":{"_consuming":false,"_dumped":false,"_events":{},"_eventsCount":2,"_readableState":{"awaitDrainWriters":null,"buffer":[],"bufferIndex":0,"highWaterMark":16384,"length":0,"pipes":[]},"aborted":false,"client":{"_SNICallback":null,"_closeAfterHandlingError":false,"_controlReleased":true,"_events":{"close":"[Array]"},"_eventsCount":9,"_hadError":false,"_host":"email.ap-southeast-2.amazonaws.com","_httpMessage":null,"_newSessionPending":false,"_parent":null,"_pendingData":null,"_pendingEncoding":"","_readableState":{"awaitDrainWriters":null,"buffer":[],"bufferIndex":0,"highWaterMark":16384,"length":0,"pipes":[]},"_rejectUnauthorized":true,"_requestCert":true,"_secureEstablished":true,"_securePending":false,"_server":null,"_sockname":null,"_tlsOptions":{"isServer":false,"pipe":false,"rejectUnauthorized":true,"requestCert":true,"secureContext":"[Object]"},"_writableState":{"bufferedIndex":0,"corked":0,"highWaterMark":16384,"length":0,"pendingcb":0,"writelen":0},"allowHalfOpen":false,"alpnProtocol":false,"authorizationError":null,"authorized":true,"autoSelectFamilyAttemptedAddresses":["16.176.84.178:443"],"connecting":false,"encrypted":true,"parser":null,"secureConnecting":false,"servername":"email.ap-southeast-2.amazonaws.com","ssl":{"_parent":"[Object]","_parentWrap":null,"_secureContext":"[Object]","reading":true},"timeout":0},"complete":true,"httpVersion":"1.1","httpVersionMajor":1,"httpVersionMinor":1,"method":null,"rawHeaders":["Date","Sun, 05 Oct 2025 19:45:57 GMT","Content-Type","text/xml","Content-Length","305","Connection","keep-alive","x-amzn-RequestId","984b4deb-2ade-4fa5-b4df-c30e2e2d2e89"],"rawTrailers":[],"req":{"_closed":true,"_contentLength":"270","_defaultKeepAlive":true,"_ended":true,"_events":{},"_eventsCount":2,"_hasBody":true,"_header":"POST / HTTP/1.1\r\ncontent-type: application/x-www-form-urlencoded\r\ncontent-length: 270\r\nx-amz-user-agent: aws-sdk-js/3.901.0\r\nuser-agent: aws-sdk-js/3.901.0 ua/2.1 os/win32#10.0.26100 lang/js md/nodejs#23.10.0 api/ses#3.901.0 m/E,e\r\nhost: email.ap-southeast-2.amazonaws.com\r\namz-sdk-invocation-id: 59346735-8ffd-48b2-b6d4-681305a89b1a\r\namz-sdk-request: attempt=1; max=3\r\nx-amz-date: 20251005T194556Z\r\nx-amz-content-sha256: 58d16f9d1f363dafae1f6bbdefe9fc719126e1048cc5178c46fa68e14159cb83\r\nauthorization: AWS4-HMAC-SHA256 Credential=test-key/20251005/ap-southeast-2/ses/aws4_request, SignedHeaders=amz-sdk-invocation-id;amz-sdk-request;content-length;content-type;host;x-amz-content-sha256;x-amz-date;x-amz-user-agent, Signature=5b8976df50f4c28995030619519a552dfaa586c49e7cfbb31c9962e5ded36848\r\nConnection: keep-alive\r\n\r\n","_headerSent":true,"_keepAliveTimeout":0,"_last":false,"_removedConnection":false,"_removedContLen":false,"_removedTE":false,"_trailer":"","aborted":false,"agent":{"_events":"[Object]","_eventsCount":2,"_sessionCache":"[Object]","defaultPort":443,"freeSockets":"[Object]","keepAlive":true,"keepAliveMsecs":1000,"maxCachedSessions":100,"maxFreeSockets":256,"maxSockets":50,"maxTotalSockets":null,"options":"[Object]","protocol":"https:","requests":{},"scheduling":"lifo","sockets":{},"totalSocketCount":1},"chunkedEncoding":false,"destroyed":true,"finished":true,"host":"email.ap-southeast-2.amazonaws.com","maxHeadersCount":null,"maxRequestsOnConnectionReached":false,"method":"POST","outputData":[],"outputSize":0,"parser":null,"path":"/","protocol":"https:","res":"[Circular]","reusedSocket":false,"sendDate":false,"shouldKeepAlive":true,"strictContentLength":false,"timeoutCb":null,"upgradeOrConnect":false,"useChunkedEncodingByDefault":true,"writable":true},"socket":null,"statusCode":403,"statusMessage":"Forbidden","upgrade":false,"url":""},"headers":{"connection":"keep-alive","content-length":"305","content-type":"text/xml","date":"Sun, 05 Oct 2025 19:45:57 GMT","x-amzn-requestid":"984b4deb-2ade-4fa5-b4df-c30e2e2d2e89"},"reason":"Forbidden","statusCode":403},"Code":"InvalidClientTokenId","Type":"Sender","message":"The security token included in the request is invalid.","name":"InvalidClientTokenId","stack":"InvalidClientTokenId: The security token included in the request is invalid.\n    at throwDefaultError (C:\\compliance-saas\\backend\\node_modules\\@smithy\\smithy-client\\dist-cjs\\index.js:287:22)\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\smithy-client\\dist-cjs\\index.js:296:9\n    at de_CommandError (C:\\compliance-saas\\backend\\node_modules\\@aws-sdk\\client-ses\\dist-cjs\\index.js:2934:14)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\middleware-serde\\dist-cjs\\index.js:8:24\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\core\\dist-cjs\\index.js:121:20\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\middleware-retry\\dist-cjs\\index.js:254:46\n    at C:\\compliance-saas\\backend\\node_modules\\@aws-sdk\\middleware-logger\\dist-cjs\\index.js:33:22\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:73:7)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSES (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:46:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:179:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:132:9)","type":"SESServiceException"},"msg":"Retrying SES email send..."}
{"level":40,"timestamp":"2025-10-05T19:45:58.285Z","env":"test","app":"compliance-saas-backend","attempt":2,"maxAttempts":3,"delay":2000,"err":{"$fault":"client","$metadata":{"attempts":1,"httpStatusCode":403,"requestId":"84e05ca7-5ca0-4757-8086-44899ed69abb","totalRetryDelay":0},"$response":{"body":{"_consuming":false,"_dumped":false,"_events":{},"_eventsCount":2,"_readableState":{"awaitDrainWriters":null,"buffer":[],"bufferIndex":0,"highWaterMark":16384,"length":0,"pipes":[]},"aborted":false,"client":{"_SNICallback":null,"_closeAfterHandlingError":false,"_controlReleased":true,"_events":{"close":"[Array]"},"_eventsCount":9,"_hadError":false,"_host":"email.ap-southeast-2.amazonaws.com","_httpMessage":null,"_newSessionPending":false,"_parent":null,"_pendingData":null,"_pendingEncoding":"","_readableState":{"awaitDrainWriters":null,"buffer":[],"bufferIndex":0,"highWaterMark":16384,"length":0,"pipes":[]},"_rejectUnauthorized":true,"_requestCert":true,"_secureEstablished":true,"_securePending":false,"_server":null,"_sockname":null,"_tlsOptions":{"isServer":false,"pipe":false,"rejectUnauthorized":true,"requestCert":true,"secureContext":"[Object]"},"_writableState":{"bufferedIndex":0,"corked":0,"highWaterMark":16384,"length":0,"pendingcb":0,"writelen":0},"allowHalfOpen":false,"alpnProtocol":false,"authorizationError":null,"authorized":true,"autoSelectFamilyAttemptedAddresses":["16.176.84.178:443"],"connecting":false,"encrypted":true,"parser":null,"secureConnecting":false,"servername":"email.ap-southeast-2.amazonaws.com","ssl":{"_parent":"[Object]","_parentWrap":null,"_secureContext":"[Object]","reading":true},"timeout":0},"complete":true,"httpVersion":"1.1","httpVersionMajor":1,"httpVersionMinor":1,"method":null,"rawHeaders":["Date","Sun, 05 Oct 2025 19:45:58 GMT","Content-Type","text/xml","Content-Length","305","Connection","keep-alive","x-amzn-RequestId","84e05ca7-5ca0-4757-8086-44899ed69abb"],"rawTrailers":[],"req":{"_closed":true,"_contentLength":"270","_defaultKeepAlive":true,"_ended":true,"_events":{},"_eventsCount":2,"_hasBody":true,"_header":"POST / HTTP/1.1\r\ncontent-type: application/x-www-form-urlencoded\r\ncontent-length: 270\r\nx-amz-user-agent: aws-sdk-js/3.901.0\r\nuser-agent: aws-sdk-js/3.901.0 ua/2.1 os/win32#10.0.26100 lang/js md/nodejs#23.10.0 api/ses#3.901.0 m/E,e\r\nhost: email.ap-southeast-2.amazonaws.com\r\namz-sdk-invocation-id: a63ffb2f-43ae-4533-842b-c703d4e30d3c\r\namz-sdk-request: attempt=1; max=3\r\nx-amz-date: 20251005T194558Z\r\nx-amz-content-sha256: 58d16f9d1f363dafae1f6bbdefe9fc719126e1048cc5178c46fa68e14159cb83\r\nauthorization: AWS4-HMAC-SHA256 Credential=test-key/20251005/ap-southeast-2/ses/aws4_request, SignedHeaders=amz-sdk-invocation-id;amz-sdk-request;content-length;content-type;host;x-amz-content-sha256;x-amz-date;x-amz-user-agent, Signature=7ccfaf0341e7bbda6dee4df5ecd68b2db333e7407567e843d68bcf284c1e16e0\r\nConnection: keep-alive\r\n\r\n","_headerSent":true,"_keepAliveTimeout":0,"_last":false,"_removedConnection":false,"_removedContLen":false,"_removedTE":false,"_trailer":"","aborted":false,"agent":{"_events":"[Object]","_eventsCount":2,"_sessionCache":"[Object]","defaultPort":443,"freeSockets":"[Object]","keepAlive":true,"keepAliveMsecs":1000,"maxCachedSessions":100,"maxFreeSockets":256,"maxSockets":50,"maxTotalSockets":null,"options":"[Object]","protocol":"https:","requests":{},"scheduling":"lifo","sockets":{},"totalSocketCount":1},"chunkedEncoding":false,"destroyed":true,"finished":true,"host":"email.ap-southeast-2.amazonaws.com","maxHeadersCount":null,"maxRequestsOnConnectionReached":false,"method":"POST","outputData":[],"outputSize":0,"parser":null,"path":"/","protocol":"https:","res":"[Circular]","reusedSocket":true,"sendDate":false,"shouldKeepAlive":true,"strictContentLength":false,"timeoutCb":null,"upgradeOrConnect":false,"useChunkedEncodingByDefault":true,"writable":true},"socket":null,"statusCode":403,"statusMessage":"Forbidden","upgrade":false,"url":""},"headers":{"connection":"keep-alive","content-length":"305","content-type":"text/xml","date":"Sun, 05 Oct 2025 19:45:58 GMT","x-amzn-requestid":"84e05ca7-5ca0-4757-8086-44899ed69abb"},"reason":"Forbidden","statusCode":403},"Code":"InvalidClientTokenId","Type":"Sender","message":"The security token included in the request is invalid.","name":"InvalidClientTokenId","stack":"InvalidClientTokenId: The security token included in the request is invalid.\n    at throwDefaultError (C:\\compliance-saas\\backend\\node_modules\\@smithy\\smithy-client\\dist-cjs\\index.js:287:22)\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\smithy-client\\dist-cjs\\index.js:296:9\n    at de_CommandError (C:\\compliance-saas\\backend\\node_modules\\@aws-sdk\\client-ses\\dist-cjs\\index.js:2934:14)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\middleware-serde\\dist-cjs\\index.js:8:24\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\core\\dist-cjs\\index.js:121:20\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\middleware-retry\\dist-cjs\\index.js:254:46\n    at C:\\compliance-saas\\backend\\node_modules\\@aws-sdk\\middleware-logger\\dist-cjs\\index.js:33:22\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:73:7)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSES (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:46:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:179:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:132:9)","type":"SESServiceException"},"msg":"Operation failed, retrying..."}
{"level":40,"timestamp":"2025-10-05T19:45:58.285Z","env":"test","app":"compliance-saas-backend","attempt":2,"to":"recipient@example.com","err":{"$fault":"client","$metadata":{"attempts":1,"httpStatusCode":403,"requestId":"84e05ca7-5ca0-4757-8086-44899ed69abb","totalRetryDelay":0},"$response":{"body":{"_consuming":false,"_dumped":false,"_events":{},"_eventsCount":2,"_readableState":{"awaitDrainWriters":null,"buffer":[],"bufferIndex":0,"highWaterMark":16384,"length":0,"pipes":[]},"aborted":false,"client":{"_SNICallback":null,"_closeAfterHandlingError":false,"_controlReleased":true,"_events":{"close":"[Array]"},"_eventsCount":9,"_hadError":false,"_host":"email.ap-southeast-2.amazonaws.com","_httpMessage":null,"_newSessionPending":false,"_parent":null,"_pendingData":null,"_pendingEncoding":"","_readableState":{"awaitDrainWriters":null,"buffer":[],"bufferIndex":0,"highWaterMark":16384,"length":0,"pipes":[]},"_rejectUnauthorized":true,"_requestCert":true,"_secureEstablished":true,"_securePending":false,"_server":null,"_sockname":null,"_tlsOptions":{"isServer":false,"pipe":false,"rejectUnauthorized":true,"requestCert":true,"secureContext":"[Object]"},"_writableState":{"bufferedIndex":0,"corked":0,"highWaterMark":16384,"length":0,"pendingcb":0,"writelen":0},"allowHalfOpen":false,"alpnProtocol":false,"authorizationError":null,"authorized":true,"autoSelectFamilyAttemptedAddresses":["16.176.84.178:443"],"connecting":false,"encrypted":true,"parser":null,"secureConnecting":false,"servername":"email.ap-southeast-2.amazonaws.com","ssl":{"_parent":"[Object]","_parentWrap":null,"_secureContext":"[Object]","reading":true},"timeout":0},"complete":true,"httpVersion":"1.1","httpVersionMajor":1,"httpVersionMinor":1,"method":null,"rawHeaders":["Date","Sun, 05 Oct 2025 19:45:58 GMT","Content-Type","text/xml","Content-Length","305","Connection","keep-alive","x-amzn-RequestId","84e05ca7-5ca0-4757-8086-44899ed69abb"],"rawTrailers":[],"req":{"_closed":true,"_contentLength":"270","_defaultKeepAlive":true,"_ended":true,"_events":{},"_eventsCount":2,"_hasBody":true,"_header":"POST / HTTP/1.1\r\ncontent-type: application/x-www-form-urlencoded\r\ncontent-length: 270\r\nx-amz-user-agent: aws-sdk-js/3.901.0\r\nuser-agent: aws-sdk-js/3.901.0 ua/2.1 os/win32#10.0.26100 lang/js md/nodejs#23.10.0 api/ses#3.901.0 m/E,e\r\nhost: email.ap-southeast-2.amazonaws.com\r\namz-sdk-invocation-id: a63ffb2f-43ae-4533-842b-c703d4e30d3c\r\namz-sdk-request: attempt=1; max=3\r\nx-amz-date: 20251005T194558Z\r\nx-amz-content-sha256: 58d16f9d1f363dafae1f6bbdefe9fc719126e1048cc5178c46fa68e14159cb83\r\nauthorization: AWS4-HMAC-SHA256 Credential=test-key/20251005/ap-southeast-2/ses/aws4_request, SignedHeaders=amz-sdk-invocation-id;amz-sdk-request;content-length;content-type;host;x-amz-content-sha256;x-amz-date;x-amz-user-agent, Signature=7ccfaf0341e7bbda6dee4df5ecd68b2db333e7407567e843d68bcf284c1e16e0\r\nConnection: keep-alive\r\n\r\n","_headerSent":true,"_keepAliveTimeout":0,"_last":false,"_removedConnection":false,"_removedContLen":false,"_removedTE":false,"_trailer":"","aborted":false,"agent":{"_events":"[Object]","_eventsCount":2,"_sessionCache":"[Object]","defaultPort":443,"freeSockets":"[Object]","keepAlive":true,"keepAliveMsecs":1000,"maxCachedSessions":100,"maxFreeSockets":256,"maxSockets":50,"maxTotalSockets":null,"options":"[Object]","protocol":"https:","requests":{},"scheduling":"lifo","sockets":{},"totalSocketCount":1},"chunkedEncoding":false,"destroyed":true,"finished":true,"host":"email.ap-southeast-2.amazonaws.com","maxHeadersCount":null,"maxRequestsOnConnectionReached":false,"method":"POST","outputData":[],"outputSize":0,"parser":null,"path":"/","protocol":"https:","res":"[Circular]","reusedSocket":true,"sendDate":false,"shouldKeepAlive":true,"strictContentLength":false,"timeoutCb":null,"upgradeOrConnect":false,"useChunkedEncodingByDefault":true,"writable":true},"socket":null,"statusCode":403,"statusMessage":"Forbidden","upgrade":false,"url":""},"headers":{"connection":"keep-alive","content-length":"305","content-type":"text/xml","date":"Sun, 05 Oct 2025 19:45:58 GMT","x-amzn-requestid":"84e05ca7-5ca0-4757-8086-44899ed69abb"},"reason":"Forbidden","statusCode":403},"Code":"InvalidClientTokenId","Type":"Sender","message":"The security token included in the request is invalid.","name":"InvalidClientTokenId","stack":"InvalidClientTokenId: The security token included in the request is invalid.\n    at throwDefaultError (C:\\compliance-saas\\backend\\node_modules\\@smithy\\smithy-client\\dist-cjs\\index.js:287:22)\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\smithy-client\\dist-cjs\\index.js:296:9\n    at de_CommandError (C:\\compliance-saas\\backend\\node_modules\\@aws-sdk\\client-ses\\dist-cjs\\index.js:2934:14)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\middleware-serde\\dist-cjs\\index.js:8:24\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\core\\dist-cjs\\index.js:121:20\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\middleware-retry\\dist-cjs\\index.js:254:46\n    at C:\\compliance-saas\\backend\\node_modules\\@aws-sdk\\middleware-logger\\dist-cjs\\index.js:33:22\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:73:7)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSES (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:46:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:179:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:132:9)","type":"SESServiceException"},"msg":"Retrying SES email send..."}
{"level":50,"timestamp":"2025-10-05T19:46:00.337Z","env":"test","app":"compliance-saas-backend","err":{"$fault":"client","$metadata":{"attempts":1,"httpStatusCode":403,"requestId":"14932732-a970-40cd-82dd-bf88adcecb83","totalRetryDelay":0},"$response":{"body":{"_consuming":false,"_dumped":false,"_events":{},"_eventsCount":2,"_readableState":{"awaitDrainWriters":null,"buffer":[],"bufferIndex":0,"highWaterMark":16384,"length":0,"pipes":[]},"aborted":false,"client":{"_SNICallback":null,"_closeAfterHandlingError":false,"_controlReleased":true,"_events":{"close":"[Array]"},"_eventsCount":9,"_hadError":false,"_host":"email.ap-southeast-2.amazonaws.com","_httpMessage":null,"_newSessionPending":false,"_parent":null,"_pendingData":null,"_pendingEncoding":"","_readableState":{"awaitDrainWriters":null,"buffer":[],"bufferIndex":0,"highWaterMark":16384,"length":0,"pipes":[]},"_rejectUnauthorized":true,"_requestCert":true,"_secureEstablished":true,"_securePending":false,"_server":null,"_sockname":null,"_tlsOptions":{"isServer":false,"pipe":false,"rejectUnauthorized":true,"requestCert":true,"secureContext":"[Object]"},"_writableState":{"bufferedIndex":0,"corked":0,"highWaterMark":16384,"length":0,"pendingcb":0,"writelen":0},"allowHalfOpen":false,"alpnProtocol":false,"authorizationError":null,"authorized":true,"autoSelectFamilyAttemptedAddresses":["16.176.84.178:443"],"connecting":false,"encrypted":true,"parser":null,"secureConnecting":false,"servername":"email.ap-southeast-2.amazonaws.com","ssl":{"_parent":"[Object]","_parentWrap":null,"_secureContext":"[Object]","reading":true},"timeout":0},"complete":true,"httpVersion":"1.1","httpVersionMajor":1,"httpVersionMinor":1,"method":null,"rawHeaders":["Date","Sun, 05 Oct 2025 19:46:00 GMT","Content-Type","text/xml","Content-Length","305","Connection","keep-alive","x-amzn-RequestId","14932732-a970-40cd-82dd-bf88adcecb83"],"rawTrailers":[],"req":{"_closed":true,"_contentLength":"270","_defaultKeepAlive":true,"_ended":true,"_events":{},"_eventsCount":2,"_hasBody":true,"_header":"POST / HTTP/1.1\r\ncontent-type: application/x-www-form-urlencoded\r\ncontent-length: 270\r\nx-amz-user-agent: aws-sdk-js/3.901.0\r\nuser-agent: aws-sdk-js/3.901.0 ua/2.1 os/win32#10.0.26100 lang/js md/nodejs#23.10.0 api/ses#3.901.0 m/E,e\r\nhost: email.ap-southeast-2.amazonaws.com\r\namz-sdk-invocation-id: 24783a2c-391c-4d89-9dfc-62ea5292d6f8\r\namz-sdk-request: attempt=1; max=3\r\nx-amz-date: 20251005T194600Z\r\nx-amz-content-sha256: 58d16f9d1f363dafae1f6bbdefe9fc719126e1048cc5178c46fa68e14159cb83\r\nauthorization: AWS4-HMAC-SHA256 Credential=test-key/20251005/ap-southeast-2/ses/aws4_request, SignedHeaders=amz-sdk-invocation-id;amz-sdk-request;content-length;content-type;host;x-amz-content-sha256;x-amz-date;x-amz-user-agent, Signature=39a0d574a1d3a6e02f9ae9783fb3438460d54f325b64b97eb7f15d65cb7ae5af\r\nConnection: keep-alive\r\n\r\n","_headerSent":true,"_keepAliveTimeout":0,"_last":false,"_removedConnection":false,"_removedContLen":false,"_removedTE":false,"_trailer":"","aborted":false,"agent":{"_events":"[Object]","_eventsCount":2,"_sessionCache":"[Object]","defaultPort":443,"freeSockets":"[Object]","keepAlive":true,"keepAliveMsecs":1000,"maxCachedSessions":100,"maxFreeSockets":256,"maxSockets":50,"maxTotalSockets":null,"options":"[Object]","protocol":"https:","requests":{},"scheduling":"lifo","sockets":{},"totalSocketCount":1},"chunkedEncoding":false,"destroyed":true,"finished":true,"host":"email.ap-southeast-2.amazonaws.com","maxHeadersCount":null,"maxRequestsOnConnectionReached":false,"method":"POST","outputData":[],"outputSize":0,"parser":null,"path":"/","protocol":"https:","res":"[Circular]","reusedSocket":true,"sendDate":false,"shouldKeepAlive":true,"strictContentLength":false,"timeoutCb":null,"upgradeOrConnect":false,"useChunkedEncodingByDefault":true,"writable":true},"socket":null,"statusCode":403,"statusMessage":"Forbidden","upgrade":false,"url":""},"headers":{"connection":"keep-alive","content-length":"305","content-type":"text/xml","date":"Sun, 05 Oct 2025 19:46:00 GMT","x-amzn-requestid":"14932732-a970-40cd-82dd-bf88adcecb83"},"reason":"Forbidden","statusCode":403},"Code":"InvalidClientTokenId","Type":"Sender","message":"The security token included in the request is invalid.","name":"InvalidClientTokenId","stack":"InvalidClientTokenId: The security token included in the request is invalid.\n    at throwDefaultError (C:\\compliance-saas\\backend\\node_modules\\@smithy\\smithy-client\\dist-cjs\\index.js:287:22)\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\smithy-client\\dist-cjs\\index.js:296:9\n    at de_CommandError (C:\\compliance-saas\\backend\\node_modules\\@aws-sdk\\client-ses\\dist-cjs\\index.js:2934:14)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\middleware-serde\\dist-cjs\\index.js:8:24\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\core\\dist-cjs\\index.js:121:20\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\middleware-retry\\dist-cjs\\index.js:254:46\n    at C:\\compliance-saas\\backend\\node_modules\\@aws-sdk\\middleware-logger\\dist-cjs\\index.js:33:22\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:73:7)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSES (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:46:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:179:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:132:9)","type":"SESServiceException"},"attempts":3,"msg":"Operation failed after max retry attempts"}
{"level":50,"timestamp":"2025-10-05T19:46:00.337Z","env":"test","app":"compliance-saas-backend","err":{"$fault":"client","$metadata":{"attempts":1,"httpStatusCode":403,"requestId":"14932732-a970-40cd-82dd-bf88adcecb83","totalRetryDelay":0},"$response":{"body":{"_consuming":false,"_dumped":false,"_events":{},"_eventsCount":2,"_readableState":{"awaitDrainWriters":null,"buffer":[],"bufferIndex":0,"highWaterMark":16384,"length":0,"pipes":[]},"aborted":false,"client":{"_SNICallback":null,"_closeAfterHandlingError":false,"_controlReleased":true,"_events":{"close":"[Array]"},"_eventsCount":9,"_hadError":false,"_host":"email.ap-southeast-2.amazonaws.com","_httpMessage":null,"_newSessionPending":false,"_parent":null,"_pendingData":null,"_pendingEncoding":"","_readableState":{"awaitDrainWriters":null,"buffer":[],"bufferIndex":0,"highWaterMark":16384,"length":0,"pipes":[]},"_rejectUnauthorized":true,"_requestCert":true,"_secureEstablished":true,"_securePending":false,"_server":null,"_sockname":null,"_tlsOptions":{"isServer":false,"pipe":false,"rejectUnauthorized":true,"requestCert":true,"secureContext":"[Object]"},"_writableState":{"bufferedIndex":0,"corked":0,"highWaterMark":16384,"length":0,"pendingcb":0,"writelen":0},"allowHalfOpen":false,"alpnProtocol":false,"authorizationError":null,"authorized":true,"autoSelectFamilyAttemptedAddresses":["16.176.84.178:443"],"connecting":false,"encrypted":true,"parser":null,"secureConnecting":false,"servername":"email.ap-southeast-2.amazonaws.com","ssl":{"_parent":"[Object]","_parentWrap":null,"_secureContext":"[Object]","reading":true},"timeout":0},"complete":true,"httpVersion":"1.1","httpVersionMajor":1,"httpVersionMinor":1,"method":null,"rawHeaders":["Date","Sun, 05 Oct 2025 19:46:00 GMT","Content-Type","text/xml","Content-Length","305","Connection","keep-alive","x-amzn-RequestId","14932732-a970-40cd-82dd-bf88adcecb83"],"rawTrailers":[],"req":{"_closed":true,"_contentLength":"270","_defaultKeepAlive":true,"_ended":true,"_events":{},"_eventsCount":2,"_hasBody":true,"_header":"POST / HTTP/1.1\r\ncontent-type: application/x-www-form-urlencoded\r\ncontent-length: 270\r\nx-amz-user-agent: aws-sdk-js/3.901.0\r\nuser-agent: aws-sdk-js/3.901.0 ua/2.1 os/win32#10.0.26100 lang/js md/nodejs#23.10.0 api/ses#3.901.0 m/E,e\r\nhost: email.ap-southeast-2.amazonaws.com\r\namz-sdk-invocation-id: 24783a2c-391c-4d89-9dfc-62ea5292d6f8\r\namz-sdk-request: attempt=1; max=3\r\nx-amz-date: 20251005T194600Z\r\nx-amz-content-sha256: 58d16f9d1f363dafae1f6bbdefe9fc719126e1048cc5178c46fa68e14159cb83\r\nauthorization: AWS4-HMAC-SHA256 Credential=test-key/20251005/ap-southeast-2/ses/aws4_request, SignedHeaders=amz-sdk-invocation-id;amz-sdk-request;content-length;content-type;host;x-amz-content-sha256;x-amz-date;x-amz-user-agent, Signature=39a0d574a1d3a6e02f9ae9783fb3438460d54f325b64b97eb7f15d65cb7ae5af\r\nConnection: keep-alive\r\n\r\n","_headerSent":true,"_keepAliveTimeout":0,"_last":false,"_removedConnection":false,"_removedContLen":false,"_removedTE":false,"_trailer":"","aborted":false,"agent":{"_events":"[Object]","_eventsCount":2,"_sessionCache":"[Object]","defaultPort":443,"freeSockets":"[Object]","keepAlive":true,"keepAliveMsecs":1000,"maxCachedSessions":100,"maxFreeSockets":256,"maxSockets":50,"maxTotalSockets":null,"options":"[Object]","protocol":"https:","requests":{},"scheduling":"lifo","sockets":{},"totalSocketCount":1},"chunkedEncoding":false,"destroyed":true,"finished":true,"host":"email.ap-southeast-2.amazonaws.com","maxHeadersCount":null,"maxRequestsOnConnectionReached":false,"method":"POST","outputData":[],"outputSize":0,"parser":null,"path":"/","protocol":"https:","res":"[Circular]","reusedSocket":true,"sendDate":false,"shouldKeepAlive":true,"strictContentLength":false,"timeoutCb":null,"upgradeOrConnect":false,"useChunkedEncodingByDefault":true,"writable":true},"socket":null,"statusCode":403,"statusMessage":"Forbidden","upgrade":false,"url":""},"headers":{"connection":"keep-alive","content-length":"305","content-type":"text/xml","date":"Sun, 05 Oct 2025 19:46:00 GMT","x-amzn-requestid":"14932732-a970-40cd-82dd-bf88adcecb83"},"reason":"Forbidden","statusCode":403},"Code":"InvalidClientTokenId","Type":"Sender","message":"The security token included in the request is invalid.","name":"InvalidClientTokenId","stack":"InvalidClientTokenId: The security token included in the request is invalid.\n    at throwDefaultError (C:\\compliance-saas\\backend\\node_modules\\@smithy\\smithy-client\\dist-cjs\\index.js:287:22)\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\smithy-client\\dist-cjs\\index.js:296:9\n    at de_CommandError (C:\\compliance-saas\\backend\\node_modules\\@aws-sdk\\client-ses\\dist-cjs\\index.js:2934:14)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\middleware-serde\\dist-cjs\\index.js:8:24\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\core\\dist-cjs\\index.js:121:20\n    at C:\\compliance-saas\\backend\\node_modules\\@smithy\\middleware-retry\\dist-cjs\\index.js:254:46\n    at C:\\compliance-saas\\backend\\node_modules\\@aws-sdk\\middleware-logger\\dist-cjs\\index.js:33:22\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:73:7)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSES (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:46:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:179:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:132:9)","type":"SESServiceException"},"options":{"to":"recipient@example.com","subject":"Test","html":"<p>Test</p>"},"msg":"Failed to send email"}
{"level":40,"timestamp":"2025-10-05T19:46:01.448Z","env":"test","app":"compliance-saas-backend","attempt":1,"maxAttempts":3,"delay":1000,"err":{"type":"Error","message":"SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}","stack":"Error: SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:135:34)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSendGrid (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:99:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:182:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:149:7)","statusCode":401},"msg":"Operation failed, retrying..."}
{"level":40,"timestamp":"2025-10-05T19:46:01.448Z","env":"test","app":"compliance-saas-backend","attempt":1,"to":"recipient@example.com","err":{"type":"Error","message":"SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}","stack":"Error: SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:135:34)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSendGrid (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:99:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:182:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:149:7)","statusCode":401},"msg":"Retrying SendGrid email send..."}
{"level":40,"timestamp":"2025-10-05T19:46:02.792Z","env":"test","app":"compliance-saas-backend","attempt":2,"maxAttempts":3,"delay":2000,"err":{"type":"Error","message":"SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}","stack":"Error: SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:135:34)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSendGrid (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:99:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:182:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:149:7)","statusCode":401},"msg":"Operation failed, retrying..."}
{"level":40,"timestamp":"2025-10-05T19:46:02.793Z","env":"test","app":"compliance-saas-backend","attempt":2,"to":"recipient@example.com","err":{"type":"Error","message":"SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}","stack":"Error: SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:135:34)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSendGrid (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:99:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:182:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:149:7)","statusCode":401},"msg":"Retrying SendGrid email send..."}
{"level":50,"timestamp":"2025-10-05T19:46:05.113Z","env":"test","app":"compliance-saas-backend","err":{"type":"Error","message":"SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}","stack":"Error: SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:135:34)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSendGrid (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:99:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:182:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:149:7)","statusCode":401},"attempts":3,"msg":"Operation failed after max retry attempts"}
{"level":50,"timestamp":"2025-10-05T19:46:05.140Z","env":"test","app":"compliance-saas-backend","err":{"type":"Error","message":"Unknown email provider: invalid-provider","stack":"Error: Unknown email provider: invalid-provider\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:188:15)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:164:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)"},"options":{"to":"recipient@example.com","subject":"Test","html":"<p>Test</p>"},"msg":"Failed to send email"}
{"level":30,"timestamp":"2025-10-05T19:46:05.166Z","env":"test","app":"compliance-saas-backend","provider":"console","to":"user@test.com","from":"FlowComply <noreply@flowcomply.com>","subject":"üîî Upcoming Deadline: Test Item (5 days)","bodyPreview":"Hello Test User,\n\nThis is a reminder notification about a compliance deadline.\n\nTest Item\nType: Test","msg":"üìß Email would be sent (console mode)"}
{"level":30,"timestamp":"2025-10-05T19:46:05.197Z","env":"test","app":"compliance-saas-backend","provider":"console","to":"user@test.com","from":"FlowComply <noreply@flowcomply.com>","subject":"üîî Upcoming Deadline: Test Item (7 days)","bodyPreview":"Hello Test User,\n\nThis is a reminder notification about a compliance deadline.\n\nTest Item\nType: Test","msg":"üìß Email would be sent (console mode)"}
(node:21132) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 11 exit listeners added to [process]. MaxListeners is 10. Use emitter.setMaxListeners() to increase limit
(Use `node --trace-warnings ...` to show where the warning was created)
{"level":30,"timestamp":"2025-10-05T19:46:05.227Z","env":"test","app":"compliance-saas-backend","provider":"console","to":"user@test.com","from":"FlowComply <noreply@flowcomply.com>","subject":"üìã Quarterly Regulation Review Required - Q1 2024","bodyPreview":"Quarterly Regulation Review - Q1 2024\n\nHello Test User,\n\nIt's time for the quarterly review of Tauma","msg":"üìß Email would be sent (console mode)"}
{"level":50,"timestamp":"2025-10-05T19:46:05.114Z","env":"test","app":"compliance-saas-backend","err":{"type":"Error","message":"SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}","stack":"Error: SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:135:34)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSendGrid (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:99:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:182:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:149:7)","statusCode":401},"options":{"to":"recipient@example.com","subject":"Test","html":"<p>Test</p>"},"msg":"Failed to send email"}
{"level":40,"timestamp":"2025-10-05T19:46:05.988Z","env":"test","app":"compliance-saas-backend","attempt":1,"maxAttempts":3,"delay":1000,"err":{"type":"Error","message":"SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}","stack":"Error: SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:135:34)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSendGrid (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:99:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:182:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:235:7)","statusCode":401},"msg":"Operation failed, retrying..."}
{"level":40,"timestamp":"2025-10-05T19:46:05.988Z","env":"test","app":"compliance-saas-backend","attempt":1,"to":"test@example.com","err":{"type":"Error","message":"SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}","stack":"Error: SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:135:34)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSendGrid (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:99:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:182:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:235:7)","statusCode":401},"msg":"Retrying SendGrid email send..."}
{"level":40,"timestamp":"2025-10-05T19:46:07.293Z","env":"test","app":"compliance-saas-backend","attempt":2,"maxAttempts":3,"delay":2000,"err":{"type":"Error","message":"SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}","stack":"Error: SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:135:34)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSendGrid (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:99:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:182:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:235:7)","statusCode":401},"msg":"Operation failed, retrying..."}
{"level":40,"timestamp":"2025-10-05T19:46:07.293Z","env":"test","app":"compliance-saas-backend","attempt":2,"to":"test@example.com","err":{"type":"Error","message":"SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}","stack":"Error: SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:135:34)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSendGrid (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:99:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:182:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:235:7)","statusCode":401},"msg":"Retrying SendGrid email send..."}
{"level":50,"timestamp":"2025-10-05T19:46:09.647Z","env":"test","app":"compliance-saas-backend","err":{"type":"Error","message":"SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}","stack":"Error: SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:135:34)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSendGrid (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:99:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:182:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:235:7)","statusCode":401},"attempts":3,"msg":"Operation failed after max retry attempts"}
{"level":30,"timestamp":"2025-10-05T19:46:09.673Z","env":"test","app":"compliance-saas-backend","provider":"console","to":"","from":"FlowComply <noreply@flowcomply.com>","subject":"Test","bodyPreview":"<p>Test</p>","msg":"üìß Email would be sent (console mode)"}
{"level":30,"timestamp":"2025-10-05T19:46:09.703Z","env":"test","app":"compliance-saas-backend","provider":"console","to":"test@example.com","from":"Custom Name <custom@example.com>","subject":"Test","bodyPreview":"<p>Test</p>","msg":"üìß Email would be sent (console mode)"}
{"level":30,"timestamp":"2025-10-05T19:46:09.731Z","env":"test","app":"compliance-saas-backend","provider":"console","to":"test@example.com","from":"FlowComply <noreply@flowcomply.com>","subject":"Test","bodyPreview":"<p>Test</p>","msg":"üìß Email would be sent (console mode)"}
PASS src/__tests__/services/email.service.test.ts (50.598 s)
{"level":30,"timestamp":"2025-10-05T19:46:09.764Z","env":"test","app":"compliance-saas-backend","provider":"console","to":"test@example.com","from":"FlowComply <noreply@flowcomply.com>","subject":"Test","bodyPreview":"Plain text content","msg":"üìß Email would be sent (console mode)"}
{"level":30,"timestamp":"2025-10-05T19:46:09.791Z","env":"test","app":"compliance-saas-backend","provider":"console","to":"test@example.com","from":"FlowComply <noreply@flowcomply.com>","subject":"Test","bodyPreview":"<p>HTML only</p>","msg":"üìß Email would be sent (console mode)"}
{"level":50,"timestamp":"2025-10-05T19:46:09.647Z","env":"test","app":"compliance-saas-backend","err":{"type":"Error","message":"SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}","stack":"Error: SendGrid error: {\"errors\":[{\"message\":\"The provided authorization grant is invalid, expired, or revoked\",\"field\":null,\"help\":null}]}\n    at maxAttempts (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:135:34)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at retryOperation (C:\\compliance-saas\\backend\\src\\utils\\retry.util.ts:34:14)\n    at sendViaSendGrid (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:99:3)\n    at sendEmail (C:\\compliance-saas\\backend\\src\\services\\email.service.ts:182:9)\n    at Object.<anonymous> (C:\\compliance-saas\\backend\\src\\__tests__\\services\\email.service.test.ts:235:7)","statusCode":401},"options":{"to":"test@example.com","subject":"Test","html":"<p>Test</p>"},"msg":"Failed to send email"}

Test Suites: 5 failed, 4 passed, 9 total
Tests:       13 failed, 78 passed, 91 total
Snapshots:   0 total
Time:        54.676 s
Ran all test suites.
